(function(){var LocationSearch;LocationSearch=function($http,$filter,$mdSidenav){var directive;return directive={restrict:"E",scope:{resourceUrl:"@resourceUrl",fieldName:"@fieldName",fieldStreet:"@fieldStreet",fieldZip:"@fieldZip",fieldCity:"@fieldCity",initialFilters:"@initialFilters",maxResults:"@maxResults",initialZoom:"@initialZoom",fallbackCenter:"@fallbackCenter"},link:function($scope,elem,attrs){var __construct,clearMarkers,distance,filterNearby,geoSuccessHandler,getData,getDefaultLatLon,renderMap,setVariables,shuffle,updateMap;return __construct=function(){return getDefaultLatLon(),setVariables(),getData()},setVariables=function(){var defaultFilters;return $scope.initialFilters=$scope.initialFilters.replace(/ +(?= )/g,"").split(" "),$scope.maxResults=$scope.maxResults||5,$scope.initialZoom=$scope.initialZoom||8,$scope.radius=$scope.initialRadius||0,$scope.results=[],$scope.markers=[],$scope.places=[],$scope.availableFilters=null,$scope.availableRadii=[0,10,25,50,100],$scope.fields=[],$scope.addressFields={name:$scope.fieldName,street:$scope.fieldStreet,zip:$scope.fieldZip,city:$scope.fieldCity},defaultFilters=[$scope.addressFields.city,$scope.addressFields.zip,$scope.addressFields.name],$scope.defaultFilters=$scope.initialFilters||defaultFilters},$scope.getUserPosition=function(){return navigator.geolocation.getCurrentPosition(geoSuccessHandler,getDefaultLatLon)},$scope.filterPlaces=function(field){var activeField,activeFields,fields,filterByTerm,k,len,result;for(activeFields=$scope.fields.filter(function(item){return item.checked}),fields=[],k=0,len=activeFields.length;len>k;k++)activeField=activeFields[k],fields.push(activeField.label);return $scope.search.length<2?$scope.results=[]:(filterByTerm=function(item){var chunk,chunks,l,len1,len2,n,property,result;for(result=!1,chunks=$scope.search.split(" "),l=0,len1=chunks.length;len1>l;l++)for(chunk=chunks[l],n=0,len2=fields.length;len2>n;n++)property=fields[n],item[property]&&item[property].toLowerCase().indexOf(chunk.toLowerCase())>=0&&(result=!0);return result},result=$filter("filter")($scope.places,filterByTerm),$scope.radius>0&&(result=filterNearby(result)),$scope.results=shuffle(result)),updateMap()},filterNearby=function(places){var filterByDistance,result;return filterByDistance=function(item){return distance($scope.userLat,$scope.userLon,item.latitude,item.longitude,"K")<=$scope.radius},result=$filter("filter")(places,filterByDistance)},$scope.getNearby=function(){return $scope.results=shuffle(filterNearby($scope.places)),updateMap()},shuffle=function(array){var i,j,temp;for(i=array.length-1;i>0;)j=Math.floor(Math.random()*(i+1)),temp=array[i],array[i]=array[j],array[j]=temp,i--;return array.slice(0,$scope.maxResults)},clearMarkers=function(){var k,len,marker,ref;for(ref=$scope.markers,k=0,len=ref.length;len>k;k++)marker=ref[k],marker.setMap(null);return $scope.markers=[]},updateMap=function(){var bounds,data,geocoder,k,len,place,ref,results1;if($scope.results.length>0){for(bounds=new google.maps.LatLngBounds,geocoder=new google.maps.Geocoder,clearMarkers(),ref=$scope.results,results1=[],k=0,len=ref.length;len>k;k++)place=ref[k],data={address:place[$scope.addressFields.street]+" "+place[$scope.addressFields.zip]+" "+place[$scope.addressFields.city]},results1.push(function(item){return geocoder.geocode(data,function(results,status){var location,marker;return location=results[0].geometry.location,bounds.extend(new google.maps.LatLng(location.lat(),location.lng())),$scope.map.fitBounds(bounds),$scope.map.setCenter(bounds.getCenter()),marker=new google.maps.Marker({map:$scope.map,position:location}),item.marker=marker,marker.addListener("click",function(){var i,l,len1,len2,m,n,ref1,ref2;for(ref1=$scope.markers,l=0,len1=ref1.length;len1>l;l++)m=ref1[l],m.setAnimation(null);for(ref2=$scope.results,n=0,len2=ref2.length;len2>n;n++)i=ref2[n],i.active=!1;return item.active=!0,this.setAnimation(google.maps.Animation.BOUNCE),$scope.$apply()}),$scope.markers.push(marker)})}(place));return results1}return clearMarkers(),$scope.map.setZoom($scope.initialZoom),$scope.map.setCenter($scope.initialCenter)},$scope.cardOrder=null,$scope.setInactive=function(place){return place.active=!1},$scope.setActive=function(place){var i,k,l,len,len1,marker,ref,ref1;for(ref=$scope.markers,k=0,len=ref.length;len>k;k++)marker=ref[k],marker.setAnimation(null);for(ref1=$scope.places,l=0,len1=ref1.length;len1>l;l++)i=ref1[l],i.active=!1;return place.active=!0,place.marker.setAnimation(google.maps.Animation.BOUNCE)},geoSuccessHandler=function(position){return $scope.userLat=position.coords.latitude,$scope.userLon=position.coords.longitude,$scope.initialCenter=new google.maps.LatLng(position.coords.latitude,position.coords.longitude),$scope.$apply(),renderMap()},distance=function(lat1,lon1,lat2,lon2,unit){var dist,radlat1,radlat2,radtheta,theta;return radlat1=Math.PI*lat1/180,radlat2=Math.PI*lat2/180,theta=lon1-lon2,radtheta=Math.PI*theta/180,dist=Math.sin(radlat1)*Math.sin(radlat2)+Math.cos(radlat1)*Math.cos(radlat2)*Math.cos(radtheta),dist=Math.acos(dist),dist=180*dist/Math.PI,dist=60*dist*1.1515,"K"===unit&&(dist=1.609344*dist),"N"===unit&&(dist=.8684*dist),dist},renderMap=function(){var mapOptions;return mapOptions={zoom:$scope.initialZoom,scrollwheel:!1,disableDefaultUI:!0,center:$scope.initialCenter},$scope.map=new google.maps.Map(document.getElementById("gmapSearchContainer"),mapOptions)},$scope.toggleSidenav=function(){return $mdSidenav("left").toggle()},getDefaultLatLon=function(){var data,geocoder;return geocoder=new google.maps.Geocoder,data={address:$scope.fallbackCenter},geocoder.geocode(data,function(results,status){var location;return location=results[0].geometry.location,$scope.initialCenter=new google.maps.LatLng(location.lat(),location.lng()),renderMap()})},getData=function(){return $http.get($scope.resourceUrl).success(function(d){var key,ref,value;ref=d[0];for(key in ref)value=ref[key],$scope.fields.push({label:key,checked:$scope.defaultFilters.indexOf(key)>=0?!0:!1});return $scope.places=d})},__construct()},template:'<md-sidenav class="md-sidenav-left md-whiteframe-z2 sidenav-filter" md-component-id="left">\n    <md-tabs md-stretch-tabs="always" flex md-align-tabs="bottom">\n      <md-tab>\n        <md-tab-label>\n          <span><md-icon md-font-icon="mdi-magnify" class="mdi"></md-icon></span>\n        </md-tab-label>\n        <md-tab-body>\n          <md-content class="md-padding">\n            <h2 class="md-headline">Search Nearby</h2>\n            <p class="md-body-1" ng-if="!userLat">We need your Location to enable Nearby-Search</p>\n            <md-button ng-click="getUserPosition()" class="md-raised md-primary" ng-if="!userLat">Get Position</md-button>\n            <md-input-container class="md-block">\n              <label>Radius</label>\n              <md-select\n                ng-model="radius"\n                ng-value="radius"\n                ng-disabled="!userLat"\n                ng-change="getNearby()">\n                <md-option ng-repeat="availableRadius in availableRadii" value="{{availableRadius}}">{{availableRadius}}</md-option>\n              </md-select>\n            </md-input-container>\n          </md-content>\n        </md-tab-body>\n      </md-tab>\n      <md-tab>\n        <md-tab-label>\n          <span><md-icon md-font-icon="mdi-filter-variant" class="mdi"></md-icon></span>\n        </md-tab-label>\n        <md-tab-body>\n          <md-content class="md-padding">\n            <md-switch class="md-primary" ng-repeat="field in fields"\n                       ng-model="field.checked"\n                       aria-label="{{field.label}}">{{field.label}}</md-switch>\n          </md-content>\n        </md-tab-body>\n      </md-tab>\n    </md-tabs>\n</md-sidenav>\n<md-content flex layout-padding>\n  <md-button class="md-icon-button toggleSidenav" ng-click="toggleSidenav()">\n    <md-icon class="mdi" md-font-icon="mdi-settings"></md-icon>\n  </md-button>\n  <md-button class="md-icon-button getPosition" ng-click="getUserPosition()">\n    <md-icon class="mdi" md-font-icon="mdi-crosshairs-gps"></md-icon>\n  </md-button>\n  <input id="gmapSearch" type="text" ng-model="search" ng-model-options="{debounce: 700}" ng-change="filterPlaces()" placeholder="Search">\n  <div id="gmapSearchContainer"></div>\n</md-content>\n<md-sidenav class="md-sidenav-right md-whiteframe-z2" md-component-id="right" md-is-locked-open="results.length > 0">\n  <md-content layout-padding>\n    <md-card ng-repeat="place in results | orderBy: cardOrder"\n             ng-click="setActive(place)"\n             ng-class="{active: place.active}">\n      <md-card-content>\n        <md-button class="md-raised" ng-if="place.active" ng-click="setInactive(place)">Close</md-button>\n        <h2 class="md-title">{{place[addressFields.name]}}</h2>\n        <p class="md-body-1">{{place[addressFields.street]}}<br>\n        {{place[addressFields.zip]}} {{place[addressFields.city]}}</p>\n      <md-card-content>\n    </md-card>\n  </md-content>\n</md-sidenav>'}},angular.module("nickel.locationSearch",["ngMaterial"]).directive("locationSearch",LocationSearch)}).call(this);